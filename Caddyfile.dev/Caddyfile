{
  auto_https off
  admin off
}

:80 {
  encode zstd gzip

  header {
    X-Content-Type-Options nosniff
    X-Frame-Options DENY
    Referrer-Policy no-referrer-when-downgrade
    Permissions-Policy "geolocation=(), microphone=(), camera=()"
  }

  # Matchers para rotas de API (preservando paths)
  @auth path /auth/*
  @accounts path /accounts/*
  @expenses path /expenses/*
  @incomes path /incomes/*
  @creditCards path /creditCards/*
  @budgets path /budgets/*
  @transfers path /transfers/*
  @analytics path /analytics/*
  @resumo path /resumo/*
  @dashboard path /dashboard/*
  @users path /users/*
  @notifications path /notifications*
  @export path /export/*
  @billClosing path /bill-closing/*

  # Rota genérica /api com strip do prefixo (compatível com nginx.dev.conf)
  @api path /api/*
  handle @api {
    uri strip_prefix /api
    reverse_proxy backend:3001
  }

  handle @auth {
    reverse_proxy backend:3001
  }
  handle @accounts {
    reverse_proxy backend:3001
  }
  handle @expenses {
    reverse_proxy backend:3001
  }
  handle @incomes {
    reverse_proxy backend:3001
  }
  handle @creditCards {
    reverse_proxy backend:3001
  }
  handle @budgets {
    reverse_proxy backend:3001
  }
  handle @transfers {
    reverse_proxy backend:3001
  }
  handle @analytics {
    reverse_proxy backend:3001
  }
  handle @resumo {
    reverse_proxy backend:3001
  }
  handle @dashboard {
    reverse_proxy backend:3001
  }
  handle @users {
    reverse_proxy backend:3001
  }
  handle @notifications {
    reverse_proxy backend:3001
  }
  handle @export {
    reverse_proxy backend:3001
  }
  handle @billClosing {
    reverse_proxy backend:3001
  }

  # Healthcheck simples
  @health path /health /server-test
  handle @health {
    reverse_proxy backend:3001
  }

  # SPA: tudo que não for API vai para o frontend
  handle {
    reverse_proxy frontend:80 {
      header_up Host {host}
      header_up X-Real-IP {remote}
      flush_interval -1
    }
  }
}